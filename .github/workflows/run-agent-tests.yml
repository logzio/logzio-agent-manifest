name: Agent Localhost Tests

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
  workflow_dispatch:
    inputs:
      test_specific_os:
        description: 'Test specific OS (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - linux
          - macos
          - windows

jobs:
  test-linux:
    name: Test on Linux
    if: ${{ github.event.inputs.test_specific_os == '' || github.event.inputs.test_specific_os == 'linux' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Build agent binaries
        run: make

      - name: Run localhost tests
        run: |
          chmod +x tests/run_localhost_tests.sh
          sudo ./tests/run_localhost_tests.sh --skip-build --install-dir=/opt/logzio-agent-test --debug

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: linux-test-results
          path: |
            ./tmp/test/validation/
            ./tmp/test/logs/

  test-macos:
    name: Test on macOS
    if: ${{ github.event.inputs.test_specific_os == '' || github.event.inputs.test_specific_os == 'macos' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          brew install jq yq

      - name: Build agent binaries
        run: make

      - name: Check installation directory
        run: |
          echo "Creating test directory with proper permissions"
          sudo mkdir -p /tmp/logzio-agent-test
          sudo chmod -R 777 /tmp/logzio-agent-test
          ls -la /tmp/logzio-agent-test

      - name: Run localhost tests with debug
        run: |
          chmod +x tests/run_localhost_tests.sh
          ./tests/run_localhost_tests.sh --skip-build --install-dir=/tmp/logzio-agent-test --debug

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-test-results
          path: |
            ./tmp/test/validation/
            ./tmp/test/logs/

  test-windows:
    name: Test on Windows
    if: ${{ github.event.inputs.test_specific_os == '' || github.event.inputs.test_specific_os == 'windows' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        shell: powershell
        run: |
          # Install Chocolatey packages
          choco install jq -y
          
          # Install yq using scoop
          iwr -useb get.scoop.sh | iex
          scoop install yq

      - name: Build agent binaries
        run: make windows

      - name: Run Windows localhost tests
        shell: powershell
        run: |
          # Need to run with admin privileges for Windows tests to succeed (similar to actual agent)
          if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
            Write-Host "Warning: Not running as administrator - some tests may fail due to permission issues."
          }
          
          # Run the dedicated PowerShell test script
          $testInstallDir = "$env:ProgramData\Logzio\Agent-Test"
          ./tests/Run-LocalhostTests.ps1 -BuildBinaries:$false -InstallDir $testInstallDir

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-test-results
          path: |
            ${{ runner.temp }}\LogzioTest\validation\
            ${{ runner.temp }}\LogzioTest\logs\

  test-summary:
    name: Summarize Test Results
    needs: [test-linux, test-macos, test-windows]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate test summary
        run: |
          echo "# Logz.io Agent Tests Summary" > summary.md
          echo "## Test Results" >> summary.md
          
          # Check Linux results
          if [ -d "artifacts/linux-test-results" ]; then
            echo "### Linux Tests" >> summary.md
            echo "\`\`\`" >> summary.md
            find artifacts/linux-test-results/validation -name "*-validation.txt" -exec cat {} \; >> summary.md 2>/dev/null || echo "No validation report found" >> summary.md
            echo "\`\`\`" >> summary.md
          fi
          
          # Check MacOS results
          if [ -d "artifacts/macos-test-results" ]; then
            echo "### MacOS Tests" >> summary.md
            echo "\`\`\`" >> summary.md
            find artifacts/macos-test-results/validation -name "*-validation.txt" -exec cat {} \; >> summary.md 2>/dev/null || echo "No validation report found" >> summary.md
            echo "\`\`\`" >> summary.md
          fi
          
          # Check Windows results
          if [ -d "artifacts/windows-test-results" ]; then
            echo "### Windows Tests" >> summary.md
            echo "\`\`\`" >> summary.md
            find artifacts/windows-test-results -name "*-validation.txt" -exec cat {} \; >> summary.md 2>/dev/null || echo "No validation report found" >> summary.md
            echo "\`\`\`" >> summary.md
          fi

      - name: Publish test summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: summary.md